---
import type { MarkdownHeading } from 'astro'
import type { CollectionEntry } from 'astro:content'

import 'katex/dist/katex.min.css'

import { Comment, MediumZoom } from 'astro-pure/advanced'
import { ArticleBottom, Copyright, TOC } from 'astro-pure/components/pages'
import PaperHero from '@/components/papers/PaperHero.astro'
import PaperMeta from '@/components/papers/PaperMeta.astro'
import type { Locale } from '@/i18n/locales'
import PageLayout from '@/layouts/ContentLayout.astro'
import { integ } from '@/site-config'

type PaperEntry = CollectionEntry<'papers'> | CollectionEntry<'papersEn'>

interface Props {
  paper: PaperEntry
  papers: PaperEntry[]
  headings: MarkdownHeading[]
  remarkPluginFrontmatter: Record<string, unknown>
  locale?: Locale
  back?: string
  alternatePath?: string
}

const {
  paper: { id, data },
  papers,
  headings,
  remarkPluginFrontmatter,
  locale = 'zh',
  back = '/papers',
  alternatePath
} = Astro.props

const { description, heroImage, publishDate, title, updatedDate, draft: isDraft, comment } = data

const socialImage = heroImage
  ? typeof heroImage.src === 'string'
    ? heroImage.src
    : heroImage.src.src
  : '/images/social-card.png'

const articleDate = updatedDate?.toISOString() ?? publishDate.toISOString()
const primaryColor = data.heroImage?.color ?? 'hsl(var(--primary) / var(--un-text-opacity))'
const tagBasePath = back.startsWith('/en') ? '/en/papers' : '/papers'
---

<PageLayout
  meta={{ articleDate, description, ogImage: socialImage, title }}
  highlightColor={primaryColor}
  {locale}
  {alternatePath}
  {back}
>
  {!!headings.length && <TOC {headings} slot='sidebar' />}

  <Fragment slot='header'>
    <PaperHero {data} {remarkPluginFrontmatter} {locale} {tagBasePath} />
    <PaperMeta {data} class='mt-4' />
  </Fragment>

  <slot />

  <Fragment slot='bottom'>
    <Copyright {data} />
    <ArticleBottom collections={papers as CollectionEntry<'papers'>[]} {id} class='mt-3 sm:mt-6' />
    {!isDraft && comment && <Comment class='mt-3 sm:mt-6' />}
  </Fragment>

  <slot name='bottom-sidebar' slot='bottom-sidebar' />
</PageLayout>

{integ.mediumZoom.enable && <MediumZoom />}
