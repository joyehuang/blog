---
import { Image } from 'astro:assets'
import type { InferEntrySchema } from 'astro:content'

import { FormattedDate } from 'astro-pure/user'
import { cn } from 'astro-pure/utils'
import type { Locale } from '@/i18n/locales'

type PaperSchema = InferEntrySchema<'papers'> | InferEntrySchema<'papersEn'>

interface Props {
  data: PaperSchema
  remarkPluginFrontmatter: Record<string, unknown>
  locale?: Locale
  tagBasePath?: string
}

const {
  data: {
    title,
    description,
    draft,
    heroImage,
    publishDate,
    updatedDate,
    status,
    tags,
    language,
    comment: enableComment
  },
  remarkPluginFrontmatter,
  locale = 'zh',
  tagBasePath = '/papers'
} = Astro.props

const dateTimeOptions: Intl.DateTimeFormatOptions = {
  month: 'short'
}

const statusText =
  status === 'reading' ? 'Reading' : status === 'revisit' ? 'Need Revisit' : 'Completed'

const statusClass =
  status === 'reading'
    ? 'border-amber-300/70 bg-amber-100/60 text-amber-700 dark:border-amber-700/60 dark:bg-amber-900/30 dark:text-amber-300'
    : status === 'revisit'
      ? 'border-sky-300/70 bg-sky-100/60 text-sky-700 dark:border-sky-700/60 dark:bg-sky-900/30 dark:text-sky-300'
      : 'border-emerald-300/70 bg-emerald-100/60 text-emerald-700 dark:border-emerald-700/60 dark:bg-emerald-900/30 dark:text-emerald-300'
---

{
  heroImage && (
    <div class='mb-6'>
      <Image
        src={heroImage.src}
        alt={heroImage.alt || title}
        inferSize={heroImage.inferSize}
        width={heroImage.width}
        height={heroImage.height}
        class='h-auto w-full max-w-[65ch] rounded-2xl object-contain'
        fetchpriority='high'
        loading='eager'
      />
    </div>
  )
}

{draft && <span class='text-red-500'>(Draft)</span>}

<div class='max-lg:mx-auto'>
  <div class='flex flex-wrap items-center gap-2 text-xs leading-6 text-muted-foreground'>
    <span class='inline-flex items-center gap-1'>
      <FormattedDate class='font-sans' date={publishDate} dateTimeOptions={dateTimeOptions} />
      {
        updatedDate && (
          <>
            <span>/</span>
            <span>
              Update
              <FormattedDate
                class='font-sans'
                date={updatedDate}
                dateTimeOptions={dateTimeOptions}
              />
            </span>
          </>
        )
      }
    </span>
    <span class='hidden sm:inline'>•</span>
    <span>{remarkPluginFrontmatter.minutesRead}</span>
    {
      language && (
        <>
          <span class='hidden sm:inline'>•</span>
          <span>{language}</span>
        </>
      )
    }
    <span class='hidden sm:inline'>•</span>
    <span class={cn('rounded-full border px-2 py-0.5 font-medium', statusClass)}>{statusText}</span>
  </div>

  <h1 class='mt-4 text-2xl font-medium sm:mb-2 sm:mt-6 sm:text-3xl'>{title}</h1>

  <blockquote class='mt-3 text-sm italic text-muted-foreground'>
    <q>{description}</q>
  </blockquote>

  {!!tags.length && (
    <div class='mt-3 flex flex-wrap gap-2 text-xs'>
      {tags.map((tag) => (
        <a
          aria-label={`View more papers with the tag ${tag}`}
          class='rounded-full border bg-muted px-2 py-0.5 text-muted-foreground transition-colors hover:text-primary'
          href={`${tagBasePath}/tags/${tag}`}
        >
          #{tag}
        </a>
      ))}
    </div>
  )}

  {!draft && enableComment && (
    <p class='mt-3 text-xs text-muted-foreground'>
      {locale === 'en'
        ? "After reading, feel free to share your thoughts and disagreements in the comments."
        : '阅读后欢迎在评论区讨论你对这篇论文的理解和分歧。'}
    </p>
  )}
</div>

<div class='mt-4 w-1/2 border-t max-lg:mx-auto sm:mt-6 sm:w-1/3'></div>
