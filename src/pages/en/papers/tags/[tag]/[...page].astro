---
import type { GetStaticPaths, Page } from 'astro'
import type { CollectionEntry } from 'astro:content'

import { Paginator } from 'astro-pure/components/pages'
import { getBlogCollection, getUniqueTags, sortMDByDate } from 'astro-pure/server'
import { Button } from 'astro-pure/user'
import PaperPreview from '@/components/papers/PaperPreview.astro'
import PageLayout from '@/layouts/BaseLayout.astro'
import { paperPageSize } from '@/site-config'

export const prerender = true

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const allPapers = sortMDByDate((await getBlogCollection('papersEn')) as CollectionEntry<'papersEn'>[])
  const uniqueTags = getUniqueTags(allPapers)

  return uniqueTags.flatMap((tag) => {
    const filteredPapers = allPapers.filter((paper) => paper.data.tags.includes(tag))
    return paginate(filteredPapers, {
      pageSize: paperPageSize,
      params: { tag }
    })
  })
}

interface Props {
  page: Page<CollectionEntry<'papersEn'>>
}

const { page } = Astro.props
const { tag } = Astro.params

const meta = {
  description: `View all English paper notes with tag - ${tag}`,
  title: `Paper Tag: ${tag}`
}

const paginationProps = {
  ...(page.url.prev && {
    prevUrl: {
      text: '← Previous Tags',
      url: page.url.prev
    }
  }),
  ...(page.url.next && {
    nextUrl: {
      text: 'Next Tags →',
      url: page.url.next
    }
  })
}
---

<PageLayout {meta} locale='en' alternatePath={`/papers/tags/${tag ?? ''}`}>
  <Button title='Back' href='/en/papers' style='back' />
  <main class='mt-6 lg:mt-10'>
    <div id='content-header' class='animate'>
      <h1 class='mb-6 flex items-end gap-x-2 text-3xl font-medium'>
        Paper Tag:
        <span class='text-2xl'>#{tag}</span>
      </h1>
    </div>

    <section id='content' class='animate' aria-label='Paper list'>
      <ul class='flex flex-col gap-y-3 text-start'>
        {page.data.map((paper) => <PaperPreview paper={paper} basePath='/en/papers' />)}
      </ul>
      <Paginator {...paginationProps} />
    </section>
  </main>
</PageLayout>
